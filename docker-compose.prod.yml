version: "3.9"

services:
  backend:
    # ìš´ì˜ì—ì„œëŠ” ë¡œì»¬ ë¹Œë“œ ëŒ€ì‹  ECR ì´ë¯¸ì§€ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
    # ğŸ‘‰ ECR Repository URI: AWS ECRì—ì„œ í™•ì¸ ê°€ëŠ¥
    # ì˜ˆì‹œ: <AWS_ACCOUNT_ID>.dkr.ecr.ap-northeast-2.amazonaws.com/lostparty-backend:prod-<SHA>
    # image: ${ECR_ACCOUNT}.dkr.ecr.ap-northeast-2.amazonaws.com/lostparty-backend:${IMAGE_TAG}

    restart: unless-stopped
    ports:
      - "4000:4000"   # ALB Target Groupì´ ì´ í¬íŠ¸ë¡œ ë¶™ìŒ (EC2 ë³´ì•ˆê·¸ë£¹ì€ ALB SGë§Œ í—ˆìš©)

    environment:
      NODE_ENV: ${NODE_ENV}

      # ğŸ‘‰ RDS(MySQL) ì—°ê²° ì •ë³´ (AWS RDS ì½˜ì†”ì—ì„œ ì—”ë“œí¬ì¸íŠ¸/í¬íŠ¸/ì‚¬ìš©ì ì„¤ì •)
      DB_HOST: ${DB_HOST}        # ì˜ˆ: mydb.abcdefg.ap-northeast-2.rds.amazonaws.com
      DB_PORT: ${DB_PORT}        # ê¸°ë³¸ 3306
      DB_USER: ${DB_USERNAME}        # RDS ìƒì„± ì‹œ ë§Œë“  ìœ ì €
      DB_PASSWORD: ${DB_PASSWORD}# RDS ìœ ì € ë¹„ë°€ë²ˆí˜¸
      DB_NAME: ${DB_NAME}        # ì‚¬ìš©í•  ë°ì´í„°ë² ì´ìŠ¤ ì´ë¦„

    healthcheck:
      # ğŸ‘‰ NestJSì— /health ì—”ë“œí¬ì¸íŠ¸ êµ¬í˜„ í•„ìš”
      test: ["CMD", "curl", "-f", "http://localhost:4000/admin/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  frontend:
    # ìš´ì˜ í”„ë¡ íŠ¸ì—”ë“œë„ ë¹Œë“œí•˜ì§€ ì•Šê³  ECR ì´ë¯¸ì§€ ì‚¬ìš©
    # ğŸ‘‰ ECR Repository URI: AWS ECRì—ì„œ í™•ì¸ ê°€ëŠ¥
    # image: ${ECR_ACCOUNT}.dkr.ecr.ap-northeast-2.amazonaws.com/lostparty-frontend:${IMAGE_TAG}

    restart: unless-stopped
    ports:
      - "3000:3000"   # ALB Target Groupì´ ì´ í¬íŠ¸ë¡œ ë¶™ìŒ

    environment:
      NODE_ENV: ${NODE_ENV}
      NEXT_TELEMETRY_DISABLED: 1

      # ğŸ‘‰ í”„ë¡ íŠ¸ì—”ë“œê°€ APIë¥¼ í˜¸ì¶œí•  ì£¼ì†Œ
      # ALB + ACM(HTTPS) + Route53(ë„ë©”ì¸) ì¡°í•©ì—ì„œ ìµœì¢… ì£¼ì†Œ ì‚¬ìš©
      NEXT_PUBLIC_API_BASE_URL: ${NEXT_PUBLIC_API_BASE_URL}
      # ì˜ˆ: https://lostparty.com/api

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 10s
      retries: 3
